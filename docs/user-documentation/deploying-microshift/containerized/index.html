<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>MicroShift Containerized - MicroShift.io</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=icon href=https://microshift.io/favicon.png>
<link rel=stylesheet href=/css/style.min.6719d72e323121369d5caeb4264b95d8a63cf1deaab029da67602fe5a046e0a4.css>
<link rel=stylesheet href=/css/admonition.min.d6eb578b3fe0c600dbd09a9bd27c5df86cbb30bbe9c9490df10f3ff46bd49a5b.css>
<link rel=stylesheet href=/css/search.min.b3a567381af326a096422275c22a08b280ce4129812d6644a4f27053e5324303.css>
</head>
<body class="page page-default-single">
<div id=main-menu-mobile class=main-menu-mobile>
<ul>
<li class="menu-item-🏠 home">
<a href=/>
<span>🏠 Home</span>
</a>
</li>
<li class="menu-item-📚 microshift">
<a href=/docs>
<span>📚 MicroShift</span>
</a>
</li>
<li class="menu-item-📚 about">
<a href=/docs/about/about>
<span>📚 About</span>
</a>
</li>
<li class="menu-item-🧭 getting started">
<a href=/docs/getting-started>
<span>🧭 Getting Started</span>
</a>
</li>
<li class="menu-item-⛑️ user documentation">
<a href=/docs/user-documentation/>
<span>⛑️ User Documentation</span>
</a>
</li>
<li class="menu-item-🖥️ developer documentation">
<a href=/docs/developer-documentation>
<span>🖥️ Developer Documentation</span>
</a>
</li>
<li class="menu-item-❤️ community">
<a href=/docs/community/community>
<span>❤️ Community</span>
</a>
</li>
<li class="menu-item-🔍 search">
<a href=/search>
<span>🔍 Search</span>
</a>
</li>
</ul>
</div>
<div class=wrapper>
<div class=header>
<div class=container>
<div class=logo>
<a href=https://microshift.io><img alt=Logo src=/images/logo.svg></a>
</div>
<div class=logo-mobile>
<a href=https://microshift.io><img alt=Logo src=/images/logo-mobile.svg></a>
</div>
<div id=main-menu class=main-menu>
<ul>
<li class="menu-item-🏠 home">
<a href=/>
<span>🏠 Home</span>
</a>
</li>
<li class="menu-item-📚 microshift">
<a href=/docs>
<span>📚 MicroShift</span>
</a>
</li>
<li class="menu-item-📚 about">
<a href=/docs/about/about>
<span>📚 About</span>
</a>
</li>
<li class="menu-item-🧭 getting started">
<a href=/docs/getting-started>
<span>🧭 Getting Started</span>
</a>
</li>
<li class="menu-item-⛑️ user documentation">
<a href=/docs/user-documentation/>
<span>⛑️ User Documentation</span>
</a>
</li>
<li class="menu-item-🖥️ developer documentation">
<a href=/docs/developer-documentation>
<span>🖥️ Developer Documentation</span>
</a>
</li>
<li class="menu-item-❤️ community">
<a href=/docs/community/community>
<span>❤️ Community</span>
</a>
</li>
<li class="menu-item-🔍 search">
<a href=/search>
<span>🔍 Search</span>
</a>
</li>
</ul>
</div>
<button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
</div>
</div>
<div class="container pt-2 pt-md-6 pb-3 pb-md-6">
<div class=row>
<div class="col-12 col-md-3 mb-3">
<div class=sidebar>
<aside>
<ul>
<li>
<a href=/>
<span>🏠 Home</span>
</a>
</li>
<li>
<a href=/docs>
<span>📚 MicroShift</span>
</a>
</li>
<li>
<a href=/docs/about/about>
<span>📚 About</span>
</a>
</li>
<li>
<a href=/docs/getting-started>
<span>🧭 Getting Started</span>
</a>
</li>
<li>
<a href=/docs/user-documentation/>
<span>⛑️ User Documentation</span>
</a>
</li>
<li>
<a href=/docs/developer-documentation>
<span>🖥️ Developer Documentation</span>
</a>
</li>
<li>
<a href=/docs/community/community>
<span>❤️ Community</span>
</a>
</li>
<li>
<a href=/search>
<span>🔍 Search</span>
</a>
</li>
</ul>
</aside>
</div>
</div>
<div class="col-12 col-md-9">
<h1 class=title>MicroShift Containerized</h1>
<div class=content>
<p>MicroShift can be run from a Linux container with the host CRI-O service and managed with a systemd service.</p>
<h2 id=wip-more-content-coming-soon>WIP More content coming soon</h2>
<h3 id=when-to-use>When to Use</h3>
<h3 id=deployment-architecture>Deployment Architecture</h3>
<p>MicroShift on podman, CRI-O on host</p>
<h3 id=systemd-service>Systemd service</h3>
<h3 id=auto-updates>Auto-Updates</h3>
<h2 id=pre-requisites>Pre-requisites</h2>
<ul>
<li>CRI-O service must be running on the host</li>
<li>Before running MicroShift as a systemd service, ensure to update the host <code>crio-bridge.conf</code> as</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ cat /etc/cni/net.d/crio-bridge.conf
<span class=o>{</span>
    <span class=s2>&#34;cniVersion&#34;</span>: <span class=s2>&#34;0.4.0&#34;</span>,
    <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;crio&#34;</span>,
    <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;bridge&#34;</span>,
    <span class=s2>&#34;bridge&#34;</span>: <span class=s2>&#34;cni0&#34;</span>,
    <span class=s2>&#34;isGateway&#34;</span>: true,
    <span class=s2>&#34;ipMasq&#34;</span>: true,
    <span class=s2>&#34;hairpinMode&#34;</span>: true,
    <span class=s2>&#34;ipam&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;host-local&#34;</span>,
        <span class=s2>&#34;routes&#34;</span>: <span class=o>[</span>
            <span class=o>{</span> <span class=s2>&#34;dst&#34;</span>: <span class=s2>&#34;0.0.0.0/0&#34;</span> <span class=o>}</span>
        <span class=o>]</span>,
        <span class=s2>&#34;ranges&#34;</span>: <span class=o>[</span>
            <span class=o>[{</span> <span class=s2>&#34;subnet&#34;</span>: <span class=s2>&#34;10.42.0.0/24&#34;</span> <span class=o>}]</span>
        <span class=o>]</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><h2 id=run-microshift-container-as-a-systemd-service>Run MicroShift container as a systemd service</h2>
<p>Copy <code>microshift-containerized.service</code> unit file to <code>/etc/systemd/system</code> and the <code>microshift-containerized</code> run script to <code>/usr/bin</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>curl -o /etc/systemd/system/microshift.service https://raw.githubusercontent.com/redhat-et/microshift/main/packaging/systemd/microshift-containerized.service
curl -o /usr/bin/microshift-containerized https://raw.githubusercontent.com/redhat-et/microshift/main/packaging/systemd/microshift-containerized
</code></pre></div><p>Now enable and start the service. The KUBECONFIG location will be written to <code>/var/lib/microshift/resources/kubeadmin/kubeconfig</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo systemctl <span class=nb>enable</span> microshift --now
</code></pre></div><p>Verify that MicroShift is running.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/var/lib/microshift/resources/kubeadmin/kubeconfig
kubectl get pods -A
</code></pre></div><p>Stop MicroShift service</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>systemctl stop microshift
</code></pre></div><p>You can check MicroShift via</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo podman ps
sudo critcl ps
</code></pre></div><p>To access the cluster on the host or inside the container</p>
<h3 id=access-the-cluster-inside-the-container>Access the cluster inside the container</h3>
<p>Execute the following command to get into the container:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo podman <span class=nb>exec</span> -ti microshift bash
</code></pre></div><p>Inside the container, run the following to see the pods:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/var/lib/microshift/resources/kubeadmin/kubeconfig
kubectl get pods -A
</code></pre></div><h3 id=access-the-cluster-on-the-host>Access the cluster on the host</h3>
<h4 id=linux>Linux</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nb>export</span> <span class=nv>KUBECONFIG</span><span class=o>=</span>/var/lib/microshift/resources/kubeadmin/kubeconfig
kubectl get pods -A -w
</code></pre></div><h2 id=auto-update-on-demand-via-podman>Auto-Update on demand via Podman</h2>
<p>Since Podman 3.4, Podman enables users to automate container updates using what are called auto-updates. On a high level, you can configure Podman to check the availability of new images for auto-updates, pull down these new images if needed, and restart the containers.</p>
<h3 id=configuring-podman-auto-updates>Configuring Podman auto-updates</h3>
<p>To ensure Podman is checking the fully qualified image path for new images and download them, the systemd file adds a label <code>--label "io.containers.autoupdate=registry"</code> to the <code>microshift</code> container</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/podman run <span class=se>\
</span><span class=se></span>--cidfile<span class=o>=</span>%t/%n.ctr-id <span class=se>\
</span><span class=se></span>--cgroups<span class=o>=</span>no-conmon <span class=se>\
</span><span class=se></span>--rm -d --replace <span class=se>\
</span><span class=se></span>--sdnotify<span class=o>=</span>container <span class=se>\
</span><span class=se></span>--label io.containers.autoupdate<span class=o>=</span>registry <span class=se>\
</span><span class=se></span>--privileged --name microshift <span class=se>\
</span><span class=se></span>-v /var/run:/var/run -v /sys:/sys:ro -v /var/lib:/var/lib:rw,rshared -v /lib/modules:/lib/modules -v /etc:/etc<span class=se>\
</span><span class=se></span>-v /run/containers:/run/containers -v /var/log:/var/log <span class=se>\
</span><span class=se></span>-e <span class=nv>KUBECONFIG</span><span class=o>=</span>/var/lib/microshift/resources/kubeadmin/kubeconfig <span class=se>\
</span><span class=se></span>quay.io/microshift/microshift:latest
</code></pre></div><h3 id=testing-auto-updates>Testing auto-updates</h3>
<p>Podman <code>auto-update</code> command will look for containers with the label and a systemd service file as described above. If the command finds one container, it will check for a new image, download it, restart the container service.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo podman auto-update --dry-run

UNIT                              CONTAINER                                IMAGE                                                                           POLICY      UPDATED
microshift  2f7fa3962ee0 <span class=o>(</span>microshift<span class=o>)</span>  quay.io/microshift/microshift:4.7.0-0.microshift-2021-08-31-224727-linux-amd64  registry    <span class=nb>false</span>

</code></pre></div><p>The <code>--dry-run</code> feature allows you to assemble information about which services, containers, and images need updates before applying them. To apply them do</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo  podman auto-update
</code></pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<center>
<a class=github-button href=https://github.com/redhat-et/microshift data-icon=octicon-cloud-download aria-label="redhat-et/microshift on GitHub">MicroShift</a>
<a class=github-button href=https://github.com/redhat-et/microshift data-icon=octicon-star aria-label="Star redhat-et/microshift on GitHub">Star</a>
<a class=github-button href=https://github.com/redhat-et/microshift/fork data-icon=octicon-repo-forked aria-label="Fork redhat-et/microshift on GitHub">Fork</a>
<a class=github-button href=https://github.com/redhat-et/microshift/issues data-icon=octicon-issue-opened aria-label="Issue redhat-et/microshift on GitHub">Issue</a>
<p>Built with <a href=https://github.com/zerostaticthemes/hugo-whisper-theme>whisper-theme</a> from <a href=http://gohugo.io/>Hugo</a></p>
</center>
<script async defer src=https://buttons.github.io/buttons.js></script>
<script type=text/javascript src=/js/scripts.min.eaf147370baecdd07c022597db631f99cab1c9cd6479de586f30327a568d6a0f.js></script>
</body>
</html>